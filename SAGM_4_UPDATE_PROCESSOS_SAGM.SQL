DECLARE 


--MACRO PROCESSO
CURSOR c_macro IS
SELECT PROCESSO.PROC_CD_PROCESSO,  
      PROCESSO.PROC_CD_SUPERIOR,   
      PROCESSO.PROC_TX_HIERARQUIA   
FROM Processo PROCESSO   
WHERE  (PROCESSO.PROC_IN_STATUS = NULL OR NULL IS NULL) 
AND   PROCESSO.PROC_CD_PROCESSO IN (SELECT P.PROC_CD_PROCESSO 
                                    FROM PROCESSO P, 
                                          (SELECT DECODE(INSTR(HR.PROC_TX_HIERARQUIA,'.',1,1),0,HR.PROC_TX_HIERARQUIA,SUBSTR(HR.PROC_TX_HIERARQUIA,0,INSTR(HR.PROC_TX_HIERARQUIA,'.',1,1)-1)) MACRO 
                                          FROM PROCESSO HR 
                                          GROUP BY HR.PROC_NM_PROCESSO, HR.PROC_TX_HIERARQUIA) H 
                                    WHERE P.PROC_TX_HIERARQUIA = H.MACRO) 
                                    ORDER BY UPPER(PROCESSO.PROC_NM_PROCESSO);
--PROCESSO       
CURSOR c_processo(id_macro varchar) IS
SELECT  
    PROCESSO.PROC_CD_PROCESSO,  
    PROCESSO.PROC_CD_SUPERIOR,  
    PROCESSO.PROC_TX_HIERARQUIA  
FROM  Processo PROCESSO  
WHERE  (PROCESSO.PROC_IN_STATUS = NULL OR NULL IS NULL) 
AND   PROCESSO.PROC_CD_PROCESSO IN 
    (SELECT P.PROC_CD_PROCESSO 
       FROM PROCESSO P, (SELECT HR.PROC_TX_HIERARQUIA, DECODE(INSTR(HR.PROC_TX_HIERARQUIA,'.',1,2),0,HR.PROC_TX_HIERARQUIA,SUBSTR(HR.PROC_TX_HIERARQUIA,0,INSTR(HR.PROC_TX_HIERARQUIA,'.',1,2)-1)) MACRO 
                           FROM PROCESSO HR 
                           WHERE INSTR(HR.PROC_TX_HIERARQUIA,'.',1,1) > 0 
                           AND   HR.PROC_TX_HIERARQUIA LIKE ''||id_macro||'%' 
                           GROUP BY HR.PROC_NM_PROCESSO, HR.PROC_TX_HIERARQUIA) H 
       WHERE P.PROC_TX_HIERARQUIA = H.MACRO) ORDER BY UPPER(PROC_NM_PROCESSO);
  
--SUBPROCESSO       
CURSOR c_subprocesso(id_processo varchar) IS
SELECT  PROCESSO.PROC_CD_PROCESSO,  
        PROCESSO.PROC_CD_SUPERIOR,  
        PROCESSO.PROC_TX_HIERARQUIA   
FROM Processo PROCESSO   
WHERE (PROCESSO.PROC_IN_STATUS = NULL OR NULL IS NULL) 
AND   INSTR(PROCESSO.PROC_TX_HIERARQUIA,'.',1,2) > 0 
AND   PROCESSO.PROC_TX_HIERARQUIA LIKE ''||id_processo||'%' 
ORDER BY UPPER(PROC_NM_PROCESSO);

BEGIN

FOR rMacro IN c_macro LOOP
  --DBMS_OUTPUT.PUT_LINE(rMacro.PROC_CD_PROCESSO||' - '||rMacro.PROC_TX_HIERARQUIA);
  FOR rProcesso IN c_processo(rMacro.PROC_TX_HIERARQUIA) LOOP
     --DBMS_OUTPUT.PUT_LINE(rProcesso.PROC_CD_PROCESSO||' - '||rProcesso.PROC_TX_HIERARQUIA);
     update Processo set PROC_CD_SUPERIOR = rMacro.PROC_CD_PROCESSO where PROC_CD_PROCESSO = rProcesso.PROC_CD_PROCESSO;
     FOR rSubProcesso IN c_subprocesso(rProcesso.PROC_TX_HIERARQUIA) LOOP
         --DBMS_OUTPUT.PUT_LINE(rSubProcesso.PROC_CD_PROCESSO||' - '||rSubProcesso.PROC_TX_HIERARQUIA);
        update Processo set PROC_CD_SUPERIOR = rProcesso.PROC_CD_PROCESSO where PROC_CD_PROCESSO = rSubProcesso.PROC_CD_PROCESSO;
     END LOOP;
  END LOOP;
END LOOP;

COMMIT;

END;